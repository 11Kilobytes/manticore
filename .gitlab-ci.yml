# cache key for a ref on each job means that this job will check the cache for
# a directory image keyed on that thing, and if it exists, it will load that before
# executing the script. then it will save the image back under the same key when the job
# succeeds. so we copy-paste it all over


# for now this job tries to build the bare minimum of LLVM, to save time
llvm:
    stage: build
    script:
        - git submodule init
        - git submodule update
        - cd llvm/src
        - git log -n 1 HEAD
        - cd ..
        - mkdir build install
        - cd build
        - cmake -G "Unix Makefiles" -DCMAKE_INSTALL_PREFIX=../install -DCMAKE_BUILD_TYPE=Release ../src
        - make llc opt -j8
        # skip install and use just build/bin
    cache:
        key: "$CI_BUILD_REF"
        paths:
            - llvm/build/bin
            - llvm/install

pmlc:
    stage: build
    script:
        - uname -a
        - autoheader -Iconfig
        - autoconf -Iconfig
        - ./configure --with-llvm=./llvm/build
        - make local-install
    cache:
        key: "$CI_BUILD_REF"
        # untracked: true
        paths:
            - llvm/build/bin
            - bin
            - lib

####################
seq_llvm:
    stage: test
    script:
        - BACKEND="-llvm" ./src/regression-tests/bash-scripts/run-seq.bsh
    cache:
        key: "$CI_BUILD_REF"
        paths:
            - llvm/build/bin
            - bin
            - lib

par_llvm:
    stage: test
    script:
        - BACKEND="-llvm" ./src/regression-tests/bash-scripts/run-par.bsh
    cache:
        key: "$CI_BUILD_REF"
        paths:
            - llvm/build/bin
            - bin
            - lib
####################

####################
seq_llvm_lvl1:
    stage: test
    script:
        - BACKEND="-llopt1" ./src/regression-tests/bash-scripts/run-seq.bsh
    cache:
        key: "$CI_BUILD_REF"
        paths:
            - llvm/build/bin
            - bin
            - lib

par_llvm_lvl1:
    stage: test
    script:
        - BACKEND="-llopt1" ./src/regression-tests/bash-scripts/run-par.bsh
    cache:
        key: "$CI_BUILD_REF"
        paths:
            - llvm/build/bin
            - bin
            - lib
####################

####################
# seq_llvm_lvl2:
#     stage: test
#     script:
#         - BACKEND="-llopt2" ./src/regression-tests/bash-scripts/run-seq.bsh
#     cache:
#         key: "$CI_BUILD_REF"
#         paths:
#             - llvm/build/bin
#             - bin
#             - lib
# 
# par_llvm_lvl2:
#     stage: test
#     script:
#         - BACKEND="-llopt2" ./src/regression-tests/bash-scripts/run-par.bsh
#     cache:
#         key: "$CI_BUILD_REF"
#         paths:
#             - llvm/build/bin
#             - bin
#             - lib
####################

####################
# seq_llvm_lvl3:
#     stage: test
#     script:
#         - BACKEND="-llopt3" ./src/regression-tests/bash-scripts/run-seq.bsh
#     cache:
#         key: "$CI_BUILD_REF"
#         paths:
#             - llvm/build/bin
#             - bin
#             - lib
# 
# par_llvm_lvl3:
#     stage: test
#     script:
#         - BACKEND="-llopt3" ./src/regression-tests/bash-scripts/run-par.bsh
#     cache:
#         key: "$CI_BUILD_REF"
#         paths:
#             - llvm/build/bin
#             - bin
#             - lib
####################

####################
seq_mlrisc:
    stage: test
    script:
        - BACKEND="" ./src/regression-tests/bash-scripts/run-seq.bsh
    cache:
        key: "$CI_BUILD_REF"
        paths:
            - llvm/build/bin
            - bin
            - lib

par_mlrisc:
    stage: test
    script:
        - BACKEND="" ./src/regression-tests/bash-scripts/run-par.bsh
    cache:
        key: "$CI_BUILD_REF"
        paths:
            - llvm/build/bin
            - bin
            - lib
####################
