# Makefile
#
# COPYRIGHT (c) 2007 Manticore project. (http://manticore.cs.uchicago.edu)
# All rights reserved.
#
# @configure_output@
#

CC =		@CC@
CFLAGS =	@CFLAGS@ @PTHREAD_CFLAGS@ @CC_MODE_FLAG@
LDFLAGS =	
CPPFLAGS =	-I../include
AR =		ar
ARFLAGS =	rcv
RANLIB =	ranlib

TARGET		= libmanticore.a

VPATH		= ../include:../gc:../vproc:../misc:../machine:../config

GC_SRCS 	= minor-gc.c \
		  major-gc.c \
		  global-gc.c \
		  heap.c \
		  unix-memory.c \
		  alloc.c

VPROC_SRCS	= vproc.c

MISC_SRCS	= main.c \
		  apply.c \
		  options.c

C_SRCS		= $(GC_SRCS) $(VPROC_SRCS) $(MISC_SRCS)
C_OBJS		= $(patsubst %.c,%.o,$(C_SRCS))

ASM_SRCS	= asm-glue.S asm-scheduler.S
ASM_OBJS	= $(patsubst %.S,%.o,$(ASM_SRCS))

OBJS		= $(C_OBJS) $(ASM_OBJS)

$(TARGET):	$(OBJS)
	$(AR) $(ARFLAGS) $(TARGET) $(OBJS)
	$(RANLIB) $(TARGET)


$(ASM_OBJS): %.o : %.S asm-offsets.h
	$(CC) -c @CC_MODE_FLAG@ -I. -DNOT_C_SOURCE $(CPPFLAGS) -o $@ $<

asm-offsets.h:		gen-asm-offsets
	gen-asm-offsets > asm-offsets.h

gen-asm-offsets:	gen-asm-offsets.c manticore-rt.h vproc.h request-codes.h
	$(CC) $(CPPFLAGS) $(CFLAGS) -o gen-asm-offsets $<

gen-runtime-constants:	gen-runtime-constants.c manticore-rt.h vproc.h
	$(CC) $(CPPFLAGS) $(CFLAGS) -o gen-runtime-constants $<

.PHONY:		clean

clean:
	rm -rf $(OBJS) $(TARGET) gen-asm-offsets gen-runtime-constants asm-offsets.h

