(* dispatch.hlop
 *
 * COPYRIGHT (c) 2007 The Manticore Project (http://manticore.cs.uchicago.edu)
 * All rights reserved.
 *
 * Switch to the next thread from the host-vprocs ready queue.
 *)

#include "types.def"
#include "fgs.def"

define @dequeue (vp : vproc / exh : exh) : (fgs, fiber);
define @switch-to (vp : vproc, fgs : fgs, fiber : fiber / exh : exh) noreturn;

define inline @dispatch (vp : vproc / exh : exh) noreturn =
    let qitem : rdyq_item = @dequeue (vp / exh)
    let item : [fgs, fiber, rdyq_item] = ([fgs, fiber, rdyq_item]) qitem
    @switch-to (vp, #0(item), #1(item) / exh)
;
